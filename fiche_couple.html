<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fiche Couple et Cartographie</title>
    <script src="js/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --blue: #3498db; --dark: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        .search-bar { background: var(--dark); color: white; padding: 15px; border-radius: 8px; display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        input { padding: 8px; border-radius: 4px; border: none; width: 100px; }
        button { padding: 8px 15px; cursor: pointer; background: var(--blue); color: white; border: none; border-radius: 4px; font-weight: bold; }

        .couple-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .fiche { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--blue); }
        .fiche.mere { border-top-color: #e74c3c; }
        
        h2 { margin-top: 0; color: var(--dark); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .info { margin: 10px 0; font-size: 14px; }
        .label { font-weight: bold; color: #7f8c8d; width: 100px; display: inline-block; }

        #map { height: 300px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 20px; }
        
        .navigation { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .nav-btn { background: #95a5a6; color: white; text-decoration: none; padding: 10px 20px; border-radius: 20px; font-size: 13px; transition: 0.2s; border:none; cursor:pointer;}
        .nav-btn:hover { background: var(--dark); }
    </style>
</head>
<body>

<div class="container">
    <div class="search-bar">
        <strong>Rechercher un couple :</strong>
        <input type="number" id="sosaInput" placeholder="Sosa..." value="32">
        <button onclick="chargerCouple()">Afficher</button>
        <span id="status"></span>
    </div>

    <div class="couple-grid">
        <div id="pere-box" class="fiche"><h2>Père</h2><p>Saisissez un Sosa pour commencer</p></div>
        <div id="mere-box" class="fiche mere"><h2>Mère</h2><p>Saisissez un Sosa pour commencer</p></div>
    </div>

    <div id="map"></div>

    <div class="navigation">
        <button class="nav-btn" id="btn-enfant">⬇ Voir l'enfant</button>
        <button class="nav-btn" id="btn-parents-p">⬆ Parents du Père</button>
        <button class="nav-btn" id="btn-parents-m">⬆ Parents de la Mère</button>
    </div>
</div>

<script>
    let map;
    let markers = [];

    function initMap() {
        if (map) map.remove();
        map = L.map('map').setView([48.0, -2.0], 6); // Centré sur la France / Bretagne par défaut
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);
    }

    async function geocode(ville) {
        if (!ville || ville === "" || ville === "-") return null;
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${ville}`);
            const data = await response.json();
            if (data.length > 0) return [data[0].lat, data[0].lon];
        } catch (e) { return null; }
        return null;
    }

    function chargerCouple() {
        const sosa = parseInt(document.getElementById('sosaInput').value);
        if (isNaN(sosa)) return;

        // Déterminer le couple (père et mère)
        let sosaPere, sosaMere;
        if (sosa % 2 === 0) { // C'est un homme
            sosaPere = sosa;
            sosaMere = sosa + 1;
        } else { // C'est une femme
            sosaPere = sosa - 1;
            sosaMere = sosa;
        }

        Papa.parse("individus_nettoye.csv", {
            download: true,
            header: true,
            delimiter: ";",
            complete: async function(results) {
                const data = results.data;
                const pere = data.find(r => parseInt(r.sosa) === sosaPere);
                const mere = data.find(r => parseInt(r.sosa) === sosaMere);

                afficherIndividu('pere-box', pere, sosaPere, "Père");
                afficherIndividu('mere-box', mere, sosaMere, "Mère");

                // Mise à jour des boutons de navigation
                document.getElementById('btn-enfant').onclick = () => { document.getElementById('sosaInput').value = Math.floor(sosaPere/2); chargerCouple(); };
                document.getElementById('btn-parents-p').onclick = () => { document.getElementById('sosaInput').value = sosaPere*2; chargerCouple(); };
                document.getElementById('btn-parents-m').onclick = () => { document.getElementById('sosaInput').value = sosaMere*2; chargerCouple(); };

                // Cartographie
                initMap();
                const villes = new Set();
                [pere, mere].forEach(p => {
                    if (p) {
                        if (p.lieu_naissance) villes.add(p.lieu_naissance);
                        if (p.lieu_deces) villes.add(p.lieu_deces);
                    }
                });

                for (let ville of villes) {
                    const coords = await geocode(ville);
                    if (coords) {
                        L.marker(coords).addTo(map).bindPopup(ville);
                        map.panTo(coords);
                    }
                }
            }
        });
    }

    function afficherIndividu(divId, d, sosa, titreDefault) {
        const box = document.getElementById(divId);
        if (!d) {
            box.innerHTML = `<h2>${titreDefault}</h2><p>Inconnu (Sosa ${sosa})</p>`;
            return;
        }
        box.innerHTML = `
            <span style="float:right; background:#eee; padding:2px 8px; border-radius:10px; font-size:12px">Sosa ${sosa}</span>
            <h2>${d.nom_prenom}</h2>
            <div class="info"><span class="label">Famille:</span> ${d.id_famille}</div>
            <div class="info"><span class="label">Profession:</span> ${d.profession || '-'}</div>
            <div class="info"><span class="label">Naissance:</span> ${d.date_naissance || '?'} à ${d.lieu_naissance || '-'}</div>
            <div class="info"><span class="label">Décès:</span> ${d.date_deces || '?'} à ${d.lieu_deces || '-'}</div>
            <div style="font-size:11px; color:#95a5a6; margin-top:15px">${d.infos_complementaires || ''}</div>
        `;
    }

    window.onload = () => { initMap(); chargerCouple(); };
</script>

</body>
</html>
