<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Généalogie - 3 Générations Sosa 32</title>
    <script src="js/papaparse.min.js"></script>
    <script src="js/vis-network.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f8f9fa; }
        .header { padding: 15px; background: #2c3e50; color: white; display: flex; justify-content: space-between; align-items: center; }
        #mynetwork { flex-grow: 1; background: white; margin: 10px; border-radius: 8px; border: 1px solid #ccc; }
        .legend { font-size: 12px; color: #666; padding: 5px 20px; }
    </style>
</head>
<body>

<div class="header">
    <strong>Focus : 3 Générations Ascendantes</strong>
    <div>
        Sosa Racine : <input type="number" id="rootSosa" value="32" style="width: 60px;">
        <button onclick="loadData()">Actualiser</button>
    </div>
</div>

<div id="mynetwork"></div>
<div class="legend" id="status">Chargement...</div>

<script>
    let network = null;

    window.onload = loadData;

    function loadData() {
        const rootId = parseInt(document.getElementById('rootSosa').value);
        
        Papa.parse("individus_nettoye.csv", {
            download: true,
            header: true,
            delimiter: ";",
            skipEmptyLines: true,
            complete: function(results) {
                generateTree(results.data, rootId);
            }
        });
    }

    function generateTree(data, rootId) {
        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        
        // On définit les Sosa cibles pour 3 générations
        // G1: 32 | G2: 64,65 | G3: 128,129,130,131
        const targetSosas = new Set();
        targetSosas.add(rootId);           // G1
        targetSosas.add(rootId * 2);       // G2 (Père)
        targetSosas.add(rootId * 2 + 1);   // G2 (Mère)
        targetSosas.add(rootId * 4);       // G3 (Grand-père P)
        targetSosas.add(rootId * 4 + 1);   // G3 (Grand-mère P)
        targetSosas.add(rootId * 4 + 2);   // G3 (Grand-père M)
        targetSosas.add(rootId * 4 + 3);   // G3 (Grand-mère M)

        // On filtre les données du CSV
        const mapData = new Map();
        data.forEach(row => {
            let sosa = parseInt(row.sosa);
            if (targetSosas.has(sosa)) {
                mapData.set(sosa, row);
                nodes.add({
                    id: sosa,
                    label: row.nom_prenom + "\n[" + sosa + "]",
                    shape: 'box',
                    color: { background: sosa === rootId ? '#e67e22' : '#3498db', border: '#2c3e50' },
                    font: { color: '#fff', size: 14 },
                    level: sosa >= rootId * 4 ? 0 : (sosa >= rootId * 2 ? 1 : 2)
                });
            }
        });

        // On crée les liens uniquement entre les personnes présentes
        targetSosas.forEach(s => {
            let p = s * 2;
            let m = s * 2 + 1;
            if (mapData.has(s) && mapData.has(p)) 
                edges.add({ from: p, to: s, arrows: 'to', label: 'P', color: '#3498db' });
            if (mapData.has(s) && mapData.has(m)) 
                edges.add({ from: m, to: s, arrows: 'to', label: 'M', color: '#e74c3c' });
        });

        const container = document.getElementById('mynetwork');
        const options = {
            layout: {
                hierarchical: {
                    direction: "DU",
                    sortMethod: "directed",
                    levelSeparation: 150,
                    nodeSpacing: 250
                }
            },
            physics: false
        };

        if (network) network.destroy();
        network = new vis.Network(container, { nodes, edges }, options);
        
        document.getElementById('status').innerText = nodes.length + " personnes affichées pour l'arbre du Sosa " + rootId;
        
        // Forcer le centrage
        network.once("afterDrawing", () => network.fit());
    }
</script>
</body>
</html>
