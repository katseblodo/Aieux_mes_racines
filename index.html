<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Généalogie - Stable</title>
    <script src="js/papaparse.min.js"></script>
    <script src="js/vis-network.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { padding: 10px; background: #2c3e50; color: white; display: flex; gap: 10px; align-items: center; }
        #mynetwork { flex-grow: 1; background: white; border: 1px solid #ccc; }
        #status { font-size: 12px; color: #666; padding: 5px; }
    </style>
</head>
<body>

<div class="header">
    <strong>Focus 3 Générations</strong>
    <input type="number" id="rootSosa" value="32" style="width: 60px;">
    <button onclick="startVisualisation()">Lancer</button>
</div>

<div id="mynetwork"></div>
<div id="status">En attente...</div>

<script>
    let network = null;

    function startVisualisation() {
        const rootId = parseInt(document.getElementById('rootSosa').value);
        document.getElementById('status').innerText = "Lecture du fichier...";
        
        Papa.parse("individus_nettoye.csv", {
            download: true,
            header: true,
            delimiter: ";",
            skipEmptyLines: true,
            complete: function(results) {
                renderTree(results.data, rootId);
            }
        });
    }

    function renderTree(data, rootId) {
        // 1. Définition des cibles (3 générations)
        const targetIds = [
            rootId, 
            rootId*2, rootId*2+1, 
            rootId*4, rootId*4+1, rootId*4+2, rootId*4+3
        ];

        const nodes = [];
        const edges = [];
        const foundSosas = new Set();

        // 2. Filtrage des données
        data.forEach(row => {
            const sosa = parseInt(row.sosa);
            if (targetIds.includes(sosa)) {
                foundSosas.add(sosa);
                nodes.push({
                    id: sosa,
                    label: row.nom_prenom + "\n[" + sosa + "]",
                    shape: 'box',
                    color: { background: sosa === rootId ? '#e67e22' : '#3498db' },
                    font: { color: 'white' },
                    // On définit manuellement les niveaux pour éviter que VisJS ne boucle
                    level: sosa >= rootId*4 ? 0 : (sosa >= rootId*2 ? 1 : 2)
                });
            }
        });

        // 3. Création des liens
        foundSosas.forEach(id => {
            const p = id * 2;
            const m = id * 2 + 1;
            if (foundSosas.has(p)) edges.push({ from: p, to: id, arrows: 'to' });
            if (foundSosas.has(m)) edges.push({ from: m, to: id, arrows: 'to' });
        });

        const container = document.getElementById('mynetwork');
        
        const options = {
            layout: {
                hierarchical: {
                    enabled: true,
                    direction: "DU",
                    sortMethod: "directed",
                    levelSeparation: 150,
                    nodeSpacing: 200
                }
            },
            // --- PROTECTION ANTI-BOUCLE ---
            physics: {
                enabled: false, // On désactive totalement la physique
                stabilization: {
                    enabled: true,
                    iterations: 100 // On limite le calcul à 100 essais maximum
                }
            },
            interaction: {
                dragNodes: true,
                zoomView: true
            }
        };

        if (network) network.destroy();
        
        // Création du réseau
        network = new vis.Network(container, { nodes, edges }, options);
        
        document.getElementById('status').innerText = nodes.length + " individus affichés.";
        
        // Forcer l'arrêt de tout calcul après 500ms
        setTimeout(() => {
            network.stopSimulation();
            network.fit();
        }, 500);
    }

    // Lancer au démarrage
    window.onload = startVisualisation;
</script>
</body>
</html>
