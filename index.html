<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Généalogie - Focus Sosa 32</title>
    
    <script src="js/papaparse.min.js"></script>
    <script src="js/vis-network.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; }
        .header { padding: 10px; background: #2c3e50; color: white; display: flex; gap: 10px; align-items: center; }
        #mynetwork { flex-grow: 1; background: white; margin: 5px; border: 1px solid #ccc; }
        .info-panel { position: absolute; right: 20px; top: 70px; width: 250px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); display: none; z-index: 10; }
        #debug-log { position: absolute; bottom: 30px; left: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; font-family: monospace; font-size: 11px; max-height: 150px; overflow-y: auto; width: 300px; pointer-events: none; }
    </style>
</head>
<body>

<div class="header">
    <input type="number" id="searchSosa" placeholder="N° Sosa..." value="32">
    <button onclick="focusOnSosa(document.getElementById('searchSosa').value)">Aller au Sosa</button>
    <button onclick="resetView()">Vue d'ensemble</button>
    <span id="load-status">Initialisation...</span>
</div>

<div id="mynetwork"></div>
<div id="infoBox" class="info-panel"></div>
<div id="debug-log">Log système :<br></div>

<script>
    let network = null;
    let nodes = new vis.DataSet();
    let edges = new vis.DataSet();

    function log(msg) {
        console.log(msg);
        document.getElementById('debug-log').innerHTML += "> " + msg + "<br>";
    }

    window.onload = function() {
        log("Fenêtre chargée");
        if (typeof vis === 'undefined') return log("ERREUR : vis.js absent");
        if (typeof Papa === 'undefined') return log("ERREUR : papaparse.js absent");
        loadData();
    };

    function loadData() {
        log("Chargement du CSV...");
        Papa.parse("individus_nettoye.csv", {
            download: true,
            header: true,
            delimiter: ";",
            skipEmptyLines: true,
            complete: function(results) {
                log(results.data.length + " lignes lues");
                buildGraph(results.data);
            },
            error: function(err) {
                log("ERREUR PapaParse : " + err);
            }
        });
    }

    function buildGraph(data) {
        let sosaInFile = new Set();

        // 1. Création des nœuds
        data.forEach(row => {
            let id = parseInt(row.sosa);
            if (isNaN(id)) return;
            if (sosaInFile.has(id)) return; // Ignorer doublons

            sosaInFile.add(id);
            nodes.add({
                id: id,
                label: row.nom_prenom + "\n[" + id + "]",
                title: row.profession,
                group: row.id_famille,
                details: row
            });
        });

        log("Nœuds créés : " + sosaInFile.size);

        // 2. Création des liens
        sosaInFile.forEach(id => {
            let pere = id * 2;
            let mere = id * 2 + 1;
            if (sosaInFile.has(pere)) edges.add({ from: pere, to: id, arrows: 'to', label: 'P' });
            if (sosaInFile.has(mere)) edges.add({ from: mere, to: id, arrows: 'to', label: 'M' });
        });

        log("Liens créés");
        initNetwork();
    }

    function initNetwork() {
        const container = document.getElementById('mynetwork');
        const options = {
            layout: {
                hierarchical: {
                    direction: "DU",
                    sortMethod: "directed",
                    nodeSpacing: 150
                }
            },
            physics: false
        };

        log("Initialisation du graphique...");
        network = new vis.Network(container, { nodes: nodes, edges: edges }, options);

        network.once("afterDrawing", function() {
            log("Dessin terminé");
            document.getElementById('load-status').innerText = "Prêt";
            focusOnSosa(32);
        });

        network.on("click", function(p) {
            if (p.nodes.length > 0) {
                let d = nodes.get(p.nodes[0]).details;
                let box = document.getElementById('infoBox');
                box.style.display = 'block';
                box.innerHTML = "<b>" + d.nom_prenom + "</b><br>Sosa: " + d.sosa + "<br>Né: " + d.date_naissance + "<br>Lieu: " + d.lieu_naissance;
            }
        });
    }

    function focusOnSosa(id) {
        id = parseInt(id);
        if (nodes.get(id)) {
            log("Focus sur " + id);
            network.focus(id, { scale: 1, animation: true });
            network.selectNodes([id]);
        } else {
            log("Sosa " + id + " introuvable dans l'arbre");
        }
    }

    function resetView() {
        network.fit({ animation: true });
    }
</script>
</body>
</html>
