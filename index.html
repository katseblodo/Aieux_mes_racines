<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Généalogie - Visualisation des Individus</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/vis-network.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        .controls { 
            display: flex; gap: 10px; margin-bottom: 20px; padding: 15px; 
            background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #mynetwork {
            width: 100%; height: 600px; border: 1px solid lightgray;
            background-color: white; border-radius: 8px;
        }
        .legend { font-size: 0.9em; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <h2>Arbre des liens : Individus & Familles</h2>

    <div class="controls">
        <input type="text" id="searchSosa" placeholder="Rechercher un n° Sosa...">
        
        <select id="filterFamily">
            <option value="">Toutes les familles</option>
        </select>

        <button onclick="resetView()">Réinitialiser la vue</button>
    </div>

    <div id="mynetwork"></div>
    <p class="legend">Astuce : Utilisez la molette pour zoomer et glissez les cercles pour organiser la vue.</p>

    <script>
        let network;
        let allNodes = [];
        let allEdges = [];

        // 1. Chargement du fichier CSV
        Papa.parse("individus.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                processData(results.data);
            },
            error: function(err) {
                console.error("Erreur lors de la lecture du CSV:", err);
                alert("Impossible de lire le fichier 'individus.csv'. Vérifiez qu'il est au même endroit que l'index.html.");
            }
        });

        function processData(data) {
            const nodes = [];
            const edges = [];
            const families = new Set();

            data.forEach(person => {
                if (!person.id) return;

                // Ajout à la liste des familles pour le filtre
                if (person.famille) families.add(person.famille);

                // Création du nœud (individu)
                nodes.push({
                    id: person.id,
                    label: `${person.prenom} ${person.nom}\n(Sosa: ${person.sosa || 'N/A'})`,
                    title: `Famille: ${person.famille}`,
                    group: person.famille,
                    sosa: person.sosa
                });

                // Création des liens (Père / Mère)
                if (person.pere_id) {
                    edges.push({ from: person.pere_id, to: person.id, arrows: 'to', label: 'Père' });
                }
                if (person.mere_id) {
                    edges.push({ from: person.mere_id, to: person.id, arrows: 'to', label: 'Mère' });
                }
            });

            allNodes = new vis.DataSet(nodes);
            allEdges = new vis.DataSet(edges);

            // Remplir le menu déroulant des familles
            const select = document.getElementById('filterFamily');
            Array.from(families).sort().forEach(f => {
                let opt = document.createElement('option');
                opt.value = f;
                opt.innerHTML = f;
                select.appendChild(opt);
            });

            drawNetwork();
        }

        function drawNetwork() {
            const container = document.getElementById('mynetwork');
            const data = { nodes: allNodes, edges: allEdges };
            const options = {
                nodes: { shape: 'dot', size: 16 },
                physics: { enabled: true, barnesHut: { gravitationalConstant: -2000 } }
            };
            network = new vis.Network(container, data, options);
        }

        // --- Fonctions de Recherche et Filtre ---

        // Recherche par Sosa
        document.getElementById('searchSosa').addEventListener('input', function(e) {
            const sosaValue = e.target.value;
            const found = allNodes.get({
                filter: function (item) { return item.sosa == sosaValue; }
            });

            if (found.length > 0) {
                network.focus(found[0].id, { scale: 1.5, animation: true });
                network.selectNodes([found[0].id]);
            }
        });

        // Filtre par Famille
        document.getElementById('filterFamily').addEventListener('change', function(e) {
            const fam = e.target.value;
            if (fam === "") {
                network.setData({ nodes: allNodes, edges: allEdges });
            } else {
                const filteredNodes = allNodes.get({
                    filter: function(n) { return n.group === fam; }
                });
                // On ne montre que les nœuds de la famille
                network.setData({ nodes: new vis.DataSet(filteredNodes), edges: allEdges });
            }
        });

        function resetView() {
            network.fit({ animation: true });
            document.getElementById('searchSosa').value = "";
            document.getElementById('filterFamily').value = "";
        }
    </script>
</body>
</html>
