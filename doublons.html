<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Analyse des Doublons - Généalogie</title>
    <script src="js/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; color: #2c3e50; }
        tr:hover { background-color: #f1f1f1; }
        .sosa-badge { background: #e74c3c; color: white; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        .count-info { margin-bottom: 20px; font-weight: bold; padding: 10px; border-radius: 4px; }
        .error { background: #ffd7d7; color: #c0392b; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
<div id="menu-container"></div>
<div class="container">
    <h2>Analyse des Doublons (Sosa)</h2>
    
    <div id="status" class="count-info">Chargement du fichier...</div>

    <table id="doublesTable" style="display:none;">
        <thead>
            <tr>
                <th>N° Sosa</th>
                <th>Occurrences</th>
                <th>Noms trouvés dans le fichier</th>
            </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
    </table>
</div>

<script>
    window.onload = function() {
        if (typeof Papa === 'undefined') {
            document.getElementById('status').innerHTML = "❌ Erreur : papaparse.min.js non trouvé dans le dossier /js";
            document.getElementById('status').className = "count-info error";
            return;
        }
        analyzeDoubles();
    };

    function analyzeDoubles() {
        Papa.parse("individus_nettoye.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            delimiter: ";",
            complete: function(results) {
                const data = results.data;
                const sosaCounts = {}; // Pour compter les occurrences
                const sosaNames = {};  // Pour stocker les noms associés

                data.forEach(row => {
                    const sosa = row.sosa;
                    if (!sosa) return;

                    // Comptage
                    sosaCounts[sosa] = (sosaCounts[sosa] || 0) + 1;

                    // Stockage des noms (pour voir s'il y a des différences)
                    if (!sosaNames[sosa]) sosaNames[sosa] = [];
                    sosaNames[sosa].push(row.nom_prenom || "Sans nom");
                });

                displayResults(sosaCounts, sosaNames);
            },
            error: function() {
                document.getElementById('status').innerHTML = "❌ Erreur : Impossible de lire 'individus_nettoye.csv'.";
                document.getElementById('status').className = "count-info error";
            }
        });
    }

    function displayResults(counts, names) {
        const tbody = document.getElementById('resultsBody');
        const status = document.getElementById('status');
        const table = document.getElementById('doublesTable');
        let duplicateCount = 0;

        // On trie les sosa par numéro croissant
        const sortedSosa = Object.keys(counts).sort((a, b) => parseInt(a) - parseInt(b));

        sortedSosa.forEach(sosa => {
            if (counts[sosa] > 1) {
                duplicateCount++;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="sosa-badge">${sosa}</span></td>
                    <td>${counts[sosa]} fois</td>
                    <td>${names[sosa].join(' <br> ')}</td>
                `;
                tbody.appendChild(row);
            }
        });

        if (duplicateCount > 0) {
            status.innerHTML = `⚠️ Attention : ${duplicateCount} numéros Sosa en double détectés.`;
            status.className = "count-info error";
            table.style.display = "table";
        } else {
            status.innerHTML = "✅ Aucun doublon détecté dans le fichier.";
            status.className = "count-info success";
        }
    }
</script>
<script>
    // Fonction pour charger le menu
    fetch('menu.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('menu-container').innerHTML = data;
        });
</script>
</body>
</html>
